# green-proxy

Реверс-прокси сервер, обеспечивающий "заглушку" поверх свободно доступного ресурса в виде кастомной авторизации. В качестве авторизационного сервера используется `password.berizaryad.ru`

## Чтобы запустить на виртуальной машине

Достаточно запустить ansible-скрипт. Он подгрузит необходимые зависимости и запустит бинарный файл `/bin/proxy-runner-lin64` как демона через `systemd`.

> Важно! Необходимо указать верные флаги при запуске бинарного файла: при автоматическом развертывании они указываются в файле `/config/green-proxy.service`. Актуальный `apiKey` следует уточнять у администратора авторизационного сервера.

## Чтобы запустить локально

Необходимо скомпилировать прокси для своей архитектуры и запустить с корректными флагами.

Для компиляции используется утилита `make`. Опции:

- `make` - запуск приложения с дефолтными флагами на локали
- `mac` - компиляция для MacOS
- `lin64` - компиляция для Linux 64-bit
- `lin32` - компиляция для Linux 32-bit
- `make build-all` - компиляция бинарных файлов для всех доступных архитектур

## Что же в переменных

Для получения автомануалов по флагам достаточно скомпилировать прокси и вызвать как `./bin/proxy-runner-mac/ --h`.
В переменных окружения можно и нужно задать:

```
Usage of ./proxy-runner-mac:
  -apiKey string
    	API-ключ для доступа к /api/auth
        (default "eoAM9QK0lGl0dmXIlqYaH5rayeWAp93i/qn874T284I=")
  -authApi string
    	URL ручки /api/auth handler авторизационного сервиса
        (default "https://password.berizaryad.ru/api/auth")
  -authUrl string
    	URL сервиса атовризации
        (default "https://password.berizaryad.ru")
  -host string
    	какой сервис на локальной машине надо спрятать за прокси
        (default "http://localhost:8080")
  -port string
    	на каком порту запустить сам прокси
        (default ":3000")
  -url string
    	адрес ресурса, который необходимо проксировать
        (default "https://superset.berizaryad.ru")
```

## Принцип работы

Сервис проксирует указанный ресурс (в примере - расположенный на той же виртуальной машине), регулируя доступ. Залогиненный пользователь обладает `sessionId`-cookie на стороне браузера; значение этого токена проверяется при каждом запросе к проксируемому сервису с помощью GET-запроса /api/auth к авторизационному сервису.
Если cookie не найдена или не валидна, пользователь перенаправляется на сервис авторизации.

После авторизации сервис перенаправляет пользователя обратно на запрашиваемый ресурс с query-параметром `greenToken`, где содержится `sessionId`-токен. Прокси обрабатывает запрос, проверяет валидность токена, и при успешном ответе сервера перенаправляет на URL без `greenToken`-параметра с валидным `sessionId`-cookie в браузере.
